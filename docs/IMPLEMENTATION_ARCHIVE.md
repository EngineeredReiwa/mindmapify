# Mindmapify MVP実装ロードマップ

## 🎯 実装戦略

### 段階的アプローチ
- 各フェーズ完了時に動作確認
- 最小機能で先に進み、後で改善
- 型安全性を最優先

### 技術的重点
- 状態の不変性（Zustand + immer）
- レンダリング最適化（React.memo）
- イベントハンドリングの効率化

## 📋 実装フェーズ

### 🏗️ フェーズ1: 基盤構築（1-2日）
**目標**: データとキャンバスの基本構造

#### タスク1: 状態管理基盤構築
- [x] TypeScript型定義（Node, Connection, MindmapState）
- [x] Zustand store設計とセットアップ
- [x] 基本的なアクション（addNode, updateNode等）

**成功条件**: 型安全な状態管理ができる ✅

#### タスク2: Konvaキャンバス基本実装
- [x] Konva Stage/Layer構造
- [x] ズーム・パン機能
- [x] レスポンシブ対応

**成功条件**: 空のキャンバスが正常表示・操作できる ✅

### 🎯 フェーズ2: ノード操作（2-3日）
**目標**: ノードの作成・編集機能

#### タスク3: ノード作成機能
- [x] ツールバー「New Node」ボタンで新ノード生成
- [x] 視覚的フィードバック（選択状態、ホバー効果）
- [x] ドラッグ移動機能（座標変換問題修正済み）
- [x] キャンバスパン操作との競合状態解決

**成功条件**: ツールバーボタンでノードが出現し、正確にドラッグ移動できる ✅

#### タスク4: ノード編集機能
- [x] ダブルクリックでテキスト編集
- [x] インライン編集UI
- [x] リアルタイム更新

**成功条件**: ノードのテキストが編集できる ✅

### 🔗 フェーズ3: 接続とコード生成（2-3日）
**目標**: マインドマップの構造化

#### タスク5: ノード接続機能（修正版完成）
- [x] ノードに接続点を作成（常時表示）
- [x] 接続点をクリック&ドラッグ時に点線矢印を表示
- [x] 接続点固定位置（ドラッグで動かない）
- [x] 点線矢印を他ノードの接続点でドロップ時に実線接続に変換
- [x] 接続線の描画とアニメーション
- [x] 接続状態の管理
- [x] ノードID抽出ロジック修正（UUID完全対応）

**成功条件**: 接続点ドラッグで点線矢印表示、ドロップで実線接続作成 ✅

#### タスク6: Mermaidコード生成（ロジックツリー対応完成）
- [x] ノード構造→Mermaid構文変換（基本実装）
- [x] リアルタイム更新
- [x] サイドパネル表示
- [x] コピーボタン機能
- [x] 接続構造を含む完全なマインドマップコード生成
- [x] ルートノードの自動識別（最多接続ノード）
- [x] 階層構造の自動生成（再帰的構築）
- [x] リアルタイム更新の最適化（useMemoでメモ化）
- [x] 未接続ノードの処理
- [x] テキストクリーニング処理
- [x] Flowchart記法対応（ループ表現可能）
- [x] 関係性ラベル機能（8種類のプリセット）
- [x] 接続線ダブルクリックでラベル編集
- [x] ラベル付きFlowchartコード生成

**成功条件**: 論理関係を含むMermaid Flowchartコードが正確に生成される ✅

### ⚡ フェーズ4: 操作性向上（1-2日）
**目標**: 実用的で直感的な機能完成

#### 🎯 Phase 4A: 緊急UX改善（優先度：高）
**基本操作の改善** - ユーザビリティの根本的問題を解決

##### タスク7A: 視覚的改善
- [x] 矢印ヘッド表示の修正（方向性の明確化）
- [x] 接続線の視覚的改善（太さ、色、スタイル）

**成功条件**: 矢印の方向が一目で分かる ✅

##### タスク7B: ノード編集の改善
- [x] ノード内直接編集（別テキストボックス廃止）
- [x] テキスト自動折り返し（ノード縦長対応）
- [x] ノードサイズの動的調整

**成功条件**: ノード内で快適にテキスト編集ができる ✅

#### 🎯 Phase 4B: 操作性向上（優先度：中）
**編集機能の拡充** - より効率的な操作を実現

##### タスク8A: 削除・選択機能
- [x] Undo/Redo履歴管理（基本実装済み）
- [x] Clearボタン（全削除機能）
- [x] 個別ノード削除（Delete キー） - Deleteキー、ツールバーDeleteボタン対応完了
- [x] ツールバー削除ボタン改善（Delete/All Delete分離）
- [x] ノード選択状態の改善（1クリック編集仕様維持）
- [x] 接続線選択・削除の改善（視覚的フィードバック改善、ツールバーボタン対応）
- [x] 接続線ラベル編集機能の復旧（react-konva-utilsを使わずKonvaネイティブで実装）

**成功条件**: 直感的な削除・選択操作ができる

##### タスク8B: 接続線ラベル改善
✅ **ラベル編集機能の使いやすさ向上** - より実用的なラベル機能（完了）

- [x] ラベル選択肢の調整（現在12種類 → 8種類に絞る）
  - 「原因」「結果」「手段」「具体例」「要素」「同類」「対比」「補完」の8つに統一完了
- [x] ラベル選択画面のレイアウト修正
  - 選択肢がはみ出している問題の解決（4列2行レイアウトに変更）
  - 削除・キャンセルボタンの位置調整（左右適切配置に修正）
  - エディターサイズの最適化（380px幅に拡大）
- [x] ラベル表示の改善
  - 現在の丸囲み表示を廃止（文字がはみ出している問題解決）
  - 完全にシンプルなテキストのみ表示に変更（背景・縁取り一切なし）
  - 接続線と同色で統一感のあるデザイン実現
  - 矢印近くでの視認性向上完了

**成功条件**: ラベル編集が直感的で実用的に使える ✅

#### 🎯 Phase 4C: 将来的改善（優先度：低）
**高度な機能** - より豊富な機能を提供

##### タスク8C: 高度な編集機能
- [ ] コピー・ペースト機能
- [ ] 複数選択機能
- [ ] グループ化機能

##### タスク8D: システム改善
- [ ] パフォーマンス最適化（50ノード超での仮想化）
- [ ] エラーハンドリング強化
- [ ] アクセシビリティ改善
- [ ] TypeScript型定義の完全化
- [ ] メモリリーク対策の強化

**成功条件**: スムーズで直感的な操作感

### ✅ Phase 5A完了: 実用性向上（緊急課題）
**目標**: 「接続線編集系の根本的問題解決」達成済み

#### タスク9AA: 接続線編集系バグ修正 ✅
- [x] **ノードダブルクリック時の誤動作修正**: 関連矢印ラベル編集画面誤表示 ✅完了
  - 現在: ノードをダブルクリックすると、紐づいている矢印のラベル編集画面まで出現してしまう
  - 問題: ノード内編集時に矢印ラベル編集画面が邪魔になる
  - 改善: ノードダブルクリック時は矢印ラベル編集を起動しないよう修正
    - Canvas.tsxでノードクリック時の接続線ヒットテストをスキップ
    - NodeComponent.tsxでイベントバブリングを適切に停止
  - 影響: ユーザビリティの根本的問題、編集作業の妨げになる ✅解決済み
- [x] **矢印接続先変更機能の実装**: 既存矢印の再接続機能 ✅完了
  - 現在: 矢印を一度設定すると、宛先ノードや元ノードの変更ができない
  - 問題: 接続を間違えた場合に削除→再作成しか手段がない
  - 改善: 既存矢印の始点・終点を別のノードに変更できる機能実装
    - 選択された接続線に編集可能なハンドル（緑：始点、赤：終点）を表示
    - ハンドルクリックで編集モードに入り、新しいノードの接続点をクリックで再接続
    - Escapeキーでキャンセル、履歴管理対応
  - 方案: 矢印選択時に接続点をドラッグ可能にする、または右クリックメニューで変更
  - 影響: 編集の柔軟性と効率性の大幅向上 ✅達成

#### タスク9A: コア機能の実装 ✅
- [x] **COPYボタンの実装**: マーメイド記法のコピー機能
  - サイドパネルのCopyボタンが実際にクリップボードにコピーする
  - コピー成功時の視覚的フィードバック
  - このサイトの存在価値に直結する最重要機能

#### タスク9B: 操作性の根本改善 ✅
- [x] **スクロール操作の修正**: マウスホイールをズーム→スクロールに変更
  - 現在: マウスホイール = ズームイン/アウト
  - 改善: マウスホイール = 縦横スクロール
  - ツールバーにZoom In/Out ボタンを追加（ピンチ操作では見たい場所を正確にズームできない）
- [x] **極端なズーム時の問題解決**: ノード表示消失問題
  - 極端なズームイン/アウト時にノードが見えなくなる現象の修正
  - ズーム範囲の制限またはノード追跡機能の実装
- [x] **ズーム操作の改善**: ボタンベースのズーム制御
  - ツールバーに「Zoom In」「Zoom Out」「Reset Zoom」ボタン追加
  - マウスカーソル位置中心でのズーム実装
  - 現在のピンチ操作では意図した位置をズームできずノードを見失う問題の解決

#### タスク9C: UI/UX改善 ✅
- [x] **ボタン状態管理の改善**: Delete Node/Line ボタンの適切な有効化 ✅完了
  - Delete Node: ノード編集/選択モード時のみアクティブ
  - Delete Line: 接続線選択時のみアクティブ
  - 現在は常時アクティブで混乱を招いている → 選択状態に応じた適切な有効/無効化を実装
- [x] **ノード削除動作の改善**: 誤削除防止の実装
  - 現在: ノード内文字を全削除後にBackspace/Deleteでノード自体が削除される
  - 問題: 動作ミスが起こりやすい危険な仕様
  - 改善: ノード削除はDelete Nodeボタンのみに集約し、テキスト削除とノード削除を分離 ✅完了
- [x] **ノード内テキスト編集の改善**: ペースト機能の実装
  - 現在: ノード内にテキストをペーストできない
  - 改善: Ctrl+V でのペースト機能を有効化
  - クリップボードからのテキスト貼り付け対応 ✅完了
- [x] **ノード編集の操作性改善**: 直感的な保存・キャンセル操作 ✅完了
  - 現在: ノード外クリックで編集がキャンセルされ、Ctrl+Enterでしか確定できない
  - 問題: 直感的でない操作方法、操作方法が分からない
  - 改善1: ノード外クリックでも編集内容を自動保存 ✅完了
  - 改善2: 編集中に操作ヒント表示を復活（「Ctrl+Enter: 保存、Esc: キャンセル」等） ✅完了
- [x] **New Node位置改善**: ノード重複回避 ✅完了
  - 現在: 常にデフォルト位置に生成されノードが重なる
  - 改善: 既存ノードと重ならない位置に自動生成 → 画面内表示領域でのグリッド配置を実装
  - ノード数と位置の視認性向上 → ユーザーが見つけやすい位置に生成されるよう改善
- [x] **ボタン名称統一**: 動詞+名詞形式への統一 ✅完了
  - New Node → Add Node → 動詞+名詞形式に統一済み
  - Clear → Delete All → 一貫性のある命名に変更済み
  - 操作の一貫性向上 → ツールバー全体で統一された命名規則を採用

## 📋 残タスク（Phase 6: 細部改善）

### 🔧 Phase 6A: 操作精度向上
**目標**: より精密で快適な操作環境

#### タスク10A: 接続線操作の改善
- [x] **接続線ダブルクリック検出の精度向上** ✅完了
  - 座標変換問題を解決済み
  - ヒット検出の精度向上（30px→40px tolerance）
  - より確実なイベントハンドリング実装
  - **優先度**: 中（実用性に影響） → 解決済み

#### タスク10B: キーボードショートカット拡充  
- [ ] **ラベル編集ショートカット**
  - 数字キー1-8でプリセットラベル選択
  - Enterキーで保存、Escapeキーでキャンセル確認
  - **優先度**: 低（効率性向上）

#### タスク10C: 接続システムの根本改善
- [ ] **接続点固定システムの実装**
  - 現在: ノード移動時に接続点が動的変更される問題
  - 改善: 初回接続時の接続点（上下左右）を記録・固定
  - 接続データに接続点情報（fromSide, toSide）を追加
  - **優先度**: 高（論理構造の保持に重要）
  
- [ ] **矢印ヘッド視認性の改善**
  - 現在: 接続点に隠れる、方向が不自然な問題
  - 改善: 矢印ヘッドを接続点から適切な距離で描画
  - ベジェ曲線の接線方向で矢印角度を正確に計算
  - **優先度**: 中（視覚的分かりやすさ向上）
  
- [ ] **接続編集時の動的プレビュー実装**
  - 現在: 接続変更時に動的プレビューがなく「動いていない」と感じる
  - 問題: 初回接続時（DashedArrow使用）と接続変更時で視覚的フィードバックが異なる
  - 改善: 接続変更時もマウス移動に追従する動的プレビューを表示
  - 実装: エンドポイント編集中にDashedArrowでプレビュー表示
  - **優先度**: 高（ユーザーの直感的理解に重要）
  
- [ ] **編集モード競合の解決**
  - 現在: ノード編集中に接続編集を開始すると接続点が非表示になる
  - 問題: 2つの編集モードが同時に存在し、UI状態が矛盾
  - 改善: 接続編集開始時にノード編集を自動確定
  - 実装: 編集モード開始時の排他制御を追加
  - **優先度**: 高（編集操作の根本問題）

- [ ] **ノード編集時の操作ヒント表示改善**
  - 現在: ヒントテキストがバウンディングボックスからはみ出し、青色で目立ちすぎ
  - 問題1: バウンディングボックスによる見た目の悪さ
  - 問題2: 青色により重要情報に見える誤解
  - 改善: バウンディングボックス削除、灰色・小さいフォントに変更
  - **優先度**: 中（視覚的品質向上）

- [ ] **接続編集UXの簡素化**
  - 現在: 選択→ハンドルクリック→編集の3ステップが複雑
  - 改善案1: 右クリックメニューで直接編集
  - 改善案2: 選択時にツールチップで操作説明
  - **優先度**: 低（現在も機能するが学習コスト高）

### 🚀 Phase 6B: 将来拡張（スコープ外）
**目標**: 長期的な機能拡張

#### 高度な編集機能
- [ ] コピー・ペースト機能（ノード・接続線）
- [ ] 複数選択機能（Shiftクリック、範囲選択）
- [ ] グループ化機能
- [ ] テンプレート機能

#### システム改善
- [ ] パフォーマンス最適化（50ノード超での仮想化）
- [ ] エラーハンドリング強化
- [ ] アクセシビリティ改善（WCAG 2.1 AA準拠）
- [ ] TypeScript型定義の完全化
- [ ] メモリリーク対策の強化

## 🚀 マイルストーン進捗

### ✅ フェーズ1完了: 基盤構築
**目標**: 「ツールバーボタンでノード作成・移動」達成済み
- ✅ 空のキャンバス表示
- ✅ ツールバーでノード作成
- ✅ ドラッグ移動（座標問題修正済み）
- ✅ 基本的なMermaidコード生成

### ✅ フェーズ2完了: ノード操作
**目標**: 「ダブルクリックでテキスト編集」達成済み
- ✅ ノード作成・編集・移動の基本操作
- ✅ インライン編集UI
- ✅ テキスト入力とリアルタイム更新

### ✅ フェーズ3完了: 接続とコード生成
**目標**: 「論理関係を含むMermaid Flowchartコードが正確に生成される」達成済み
- ✅ 常時表示接続点システム
- ✅ 点線プレビュー → 実線接続変換
- ✅ 関係性ラベル機能（8種類プリセット）
- ✅ Flowchart記法対応（ループ表現可能）
- ✅ ロジックツリー構造の自動生成

### ✅ Phase 4A完了: 緊急UX改善
**目標**: 「基本操作の根本的問題解決」達成済み
- ✅ 矢印方向の明確化（三角形矢印ヘッド実装）
- ✅ ノード内直接編集（テキストエリア改善）
- ✅ テキスト自動折り返し（動的ノードサイズ対応）

### ✅ Phase 4B完了: 操作性向上
**目標**: 「編集機能の拡充」達成済み
- ✅ 個別ノード削除機能（Deleteキー・ツールバーボタン）
- ✅ ツールバー削除ボタン改善（Delete/All Delete分離）
- ✅ ノード選択状態の改善（1クリック編集仕様維持）
- ✅ 接続線選択・削除の改善（視覚的フィードバック改善、ツールバーボタン対応）
- ✅ 接続線ラベル編集機能の復旧（react-konva-utilsを使わずKonvaネイティブで実装）
- ✅ ラベル選択肢の調整（8種類に絞る）
- ✅ ラベル選択画面のレイアウト修正
- ✅ ラベル表示の改善（シンプルなテキスト表示）

### ✅ Phase 5A完了: 実用性向上
**目標**: 「接続線編集系の根本的問題解決」達成済み
- ✅ ノードダブルクリック時の誤動作修正（関連矢印ラベル編集画面誤表示）
- ✅ 矢印接続先変更機能の実装（既存矢印の再接続機能）
- ✅ COPYボタンの実装（マーメイド記法のコピー機能）
- ✅ スクロール操作の修正（マウスホイール→スクロール、ツールバーズーム）
- ✅ ノード削除動作の改善（誤削除防止の実装）
- ✅ ノード内テキスト編集の改善（ペースト機能の実装）
- ✅ ノード編集の操作性改善（直感的な保存・キャンセル操作）
- ✅ New Node位置改善（ノード重複回避、画面内配置）
- ✅ ボタン名称統一（動詞+名詞形式への統一）

### ✅ Phase 5B完了: 高度な操作機能
**目標**: 「効率的で安全なキーボード操作」達成済み
- ✅ Undo/Redo機能の完全実装（ノード移動・テキスト編集対応）
- ✅ 包括的ショートカットキー（UI統合型、安全性重視）
- ✅ 編集中削除機能（ノード編集中でもCmd+Shift+Dで削除可能）
- ✅ 連続ズーム機能（キーリピート対応、スムーズなズーム）
- ✅ 誤削除防止（何も選択されていない状態での削除禁止）
- ✅ UI統合ヘルプ（全ツールバーボタンにショートカット表示）

## 🎯 現在の機能概要

### ✅ 実装済み機能
- **ノード操作**: ツールバーでの作成、ドラッグ移動、1クリック編集、自動リサイズ、ペースト対応
- **テキスト編集**: Konva直接編集、カーソル制御、自動折り返し、複数行対応、操作ヒント表示
- **削除機能**: 個別削除（Deleteキー・ツールバー）、全削除、関連接続線自動削除、ボタン状態管理
- **接続システム**: 常時表示接続点、点線プレビュー、実線接続、接続先変更機能
- **関係性ラベル**: 8種類プリセット（原因、結果、手段、具体例、要素、同類、対比、補完）
- **コード生成**: Mermaid Flowchart記法、ループ対応、ラベル付き矢印、クリップボードコピー
- **UI/UX**: レスポンシブキャンバス、リアルタイム更新、履歴管理（Undo/Redo）、スクロール操作、ズームボタン
- **ノード配置**: 重複回避グリッド配置、画面内表示最適化
- **キーボードショートカット**: UI統合型安全ショートカット、編集中削除対応、連続ズーム、誤削除防止

### ✅ 解決済みの主要課題
- **Phase 4A**: 矢印方向不明 → 三角形矢印ヘッド実装
- **Phase 4A**: 編集の煩雑さ → ノード内直接編集改善
- **Phase 4A**: テキスト見切れ → 自動折り返し実装
- **Phase 4B**: 削除操作の混乱 → ボタン分離・状態管理改善
- **Phase 4B**: ラベル表示問題 → シンプルテキスト表示に改善
- **Phase 5A**: ノードダブルクリック誤動作 → イベント伝播制御
- **Phase 5A**: 接続先変更不可 → 再接続機能実装
- **Phase 5A**: COPYボタン未実装 → クリップボードコピー機能完成
- **Phase 5A**: スクロール/ズーム操作 → マウスホイール改善、ボタン追加
- **Phase 5A**: ノード配置問題 → グリッド配置・重複回避実装
- **Phase 5B**: キーボード操作不足 → UI統合型安全ショートカット実装
- **Phase 5B**: 編集中削除不可 → 編集中でも削除可能に改善
- **Phase 5B**: ズーム操作制限 → 連続ズーム・キーリピート対応
- **Phase 5B**: 誤削除リスク → 安全な2ステップ削除システム

### 🎮 操作方法

#### マウス操作
1. **ノード作成**: ツールバー「Add Node」ボタン
2. **ノード編集**: クリックでインライン編集開始（Ctrl+Enter保存、Esc取消、ノード外クリックで自動保存）
3. **接続作成**: 接続点をドラッグ&ドロップ
4. **接続先変更**: 選択した接続線のハンドル（緑:始点、赤:終点）をドラッグ
5. **ラベル編集**: 接続線をダブルクリック（8種類のプリセットから選択）
6. **削除**: Delete Node（ノード選択時）、Delete Line（接続線選択時）、Delete All（全削除）
7. **ズーム**: Zoom In/Out/Reset ボタン
8. **スクロール**: マウスホイールで縦横スクロール
9. **コード取得**: サイドパネル「Copy」ボタンでクリップボードにコピー

#### キーボードショートカット
- **Cmd+Shift+A**: Add Node（新規ノード追加）
- **Cmd+Shift+D**: Delete Selected（選択アイテム削除）
- **Cmd+A**: Select All（全選択）
- **Cmd+Z**: Undo（元に戻す）
- **Cmd+Y**: Redo（やり直し）
- **Cmd+Plus/Minus**: Zoom In/Out（連続ズーム対応）
- **Cmd+0**: Reset Zoom（ズームリセット）
- **?**: Help（ショートカット一覧表示）
- **Escape**: Cancel/Clear Selection（キャンセル・選択解除）

#### 安全機能
- **誤削除防止**: 何も選択されていない状態ではCmd+Shift+Dは無効
- **全削除**: Cmd+A → Cmd+Shift+D の2ステップで安全に実行
- **編集中削除**: ノード編集中でもCmd+Shift+Dで削除可能

## 📝 開発メモ

### 決定事項
- TypeScript strict mode使用
- Zustand + immer for 状態管理
- Konva for キャンバス描画
- react-konva-utils for HTML overlay
- Mermaid Flowchart記法採用（ループ対応）
- 関係性ラベル8種類プリセット
- 常時表示接続点システム
- Puppeteer for E2Eテスト自動化

### 注意点
- パフォーマンス: 50ノード超で仮想化検討
- Mermaidコード生成: useMemoでメモ化済み
- メモリリーク: useEffectクリーンアップ必須
- 座標変換: StageドラッグとNodeドラッグの競合解決済み
- UUID処理: 接続点IDの適切な分割が重要

### 🧪 テスト環境
- `npm run test:quick` - 5秒自動テスト（headless）
- `npm run test:debug` - ブラウザ表示テスト + スクリーンショット
- `npm run test:drag` - ドラッグ動作専用デバッグテスト

### ✅ Phase 6完了: 細部改善
**目標**: 「接続システムの精度向上と編集体験の改善」達成済み
- ✅ 接続線ダブルクリック検出の精度向上（座標変換問題の解決）
- ✅ 接続点固定システムの実装（ノード移動時の接続点固定）
- ✅ 接続編集時の動的プレビュー実装（初回接続と同様の視覚的フィードバック）
- ✅ 編集モード競合の解決（ノード編集中に接続編集開始時の排他制御）
- ✅ ノード編集ヒントのスタイル修正（バウンディングボックス削除とテキスト色/サイズ調整）
- ✅ 矢印ヘッド視認性改善（接続点との重複や方向の問題解決、色統一、ズレ修正）
- ✅ ラベル編集ショートカット実装（数字キー1-8での関係性ラベル選択）

### 🚀 Phase 7: MVP完成仕上げ
**目標**: プロダクションレディな品質への最終調整

#### Phase 7A: 緊急UX修正（完了済み）
- [x] **ラベル編集後の編集モード問題修正** ✅完了
  - 現在: ラベル確定後に矢印が編集モードに入り、終点選択を強要される
  - 問題: ユーザー期待値との乖離、操作フローの混乱
  - 改善: ラベル確定時に編集状態を完全リセット
  - 実装: ConnectionLabelEditor の onSave 時の状態管理調整
  - **優先度**: 高（UX重大問題、即座修正可能）

- [x] **接続点選択方法の修正** ✅完了
  - 現在: 固定接続点維持（fromSide, toSide記録）による位置固定
  - 問題: ノード移動時の視覚的不自然さ
  - 改善: 固定維持から最短距離自動選択に変更
  - 実装: ノード移動時とエンドポイント変更時に最適接続点を再計算
  - **優先度**: 高（自然な動作への改善）

- [x] **Mermaidコード構造化機能（LLM連携強化）** ✅完了
  - 現在: 平坦な関係列挙でLLMでの論理構造分析が困難
  - 問題: コピーしたコードが論理関係を読みにくい形式
  - 改善: 最長チェーン検出＋階層構造変換によるLLM最適化
  - 実装: タブ機能追加（Raw/LLM最適化）、構造化コード生成、サイドバースクロール修正
  - 効果: LLMでの構造分析効率向上、ディスカッション品質向上
  - **優先度**: 高（LLM連携の核心機能強化）

#### 🚨 Phase 8: 緊急UX課題修正（新規発見）
**目標**: 基本操作の安定性確保とLLM最適化の品質向上

##### 8A: 操作安定性の緊急修正（高優先度）
- [ ] **ノードダブルクリック無効化**
  - **現在の問題**: ダブルクリックでテキスト編集ができなくなる
    - 症状: ノードをダブルクリックすると編集不可状態になる
    - 原因: onDoubleClick と onClick の競合、イベント処理の競合状態
    - 影響: ユーザーが編集できず困惑、操作方法が不明瞭
  - **期待動作**: シングルクリックのみで編集開始、ダブルクリックは無反応
  - **修正方針**: 
    - NodeComponent.tsx の handleClick でダブルクリック検出時は処理を停止
    - または onDoubleClick ハンドラーを追加して preventDefault() で無効化
    - onClick のタイミング調整（ダブルクリック判定後に実行）
  - **修正箇所**: `/src/components/Node/NodeComponent.tsx`
    - handleClick 関数内でダブルクリック判定ロジック追加
    - 必要に応じて onDoubleClick ハンドラー追加
  - **テスト方法**: ノードを素早くダブルクリックして編集可能状態を確認
  - **優先度**: 高（基本操作の重大問題）

- [ ] **ノード編集中の表示安定化**
  - **現在の問題**: 同じ文字列で1秒ごとに改行が変わる挙動を繰り返す
    - 症状: 「New Nodeaaaaaaa|」が改行されたり、されなかったりが1秒周期で変化
    - 原因: updateNodeSizeForText の頻繁な呼び出しとカーソル点滅の競合
    - 副原因: cursorPosition や editingText の変更によるuseEffect連鎖
    - 影響: 編集中の視覚的不安定さ、ユーザーの集中力阻害
  - **期待動作**: 編集中のノードサイズ・改行が安定、カーソル点滅のみ変化
  - **修正方針**:
    - updateNodeSizeForText の呼び出し条件を厳格化（文字数変化時のみ）
    - カーソル点滅エフェクトと分離（サイズ計算を cursorVisible 変更で実行しない）
    - debounce または throttle でサイズ計算の頻度制限
  - **修正箇所**: `/src/components/Node/NodeComponent.tsx`
    - useEffect 依存配列の見直し（行401-408）
    - updateNodeSizeForText の呼び出し条件修正
    - カーソル点滅 useEffect から除外（行367-376）
  - **テスト方法**: 長いテキストで編集中に1分間観察、改行位置が安定していることを確認
  - **優先度**: 高（編集体験の根本問題）

- [ ] **ノード同時編集防止**
  - **現在の問題**: ノードA編集中にノードBをクリックすると同時編集状態になる
    - 症状: 複数ノードが同時にisEditing=trueになる状態
    - 原因: 新しいノード編集開始時に既存の編集中ノードを自動終了していない
    - 副作用: テキスト入力が意図しないノードに反映される可能性
    - 影響: データ破損リスク、UI状態の矛盾
  - **期待動作**: ノードB編集開始時にノードAを自動保存して編集終了、Bのみ編集状態
  - **修正方針**:
    - startEditing アクション実行前に全ノードの編集を終了
    - または NodeComponent の handleClick で他の編集中ノードをチェック・保存
    - ストアレベルで排他制御を実装（一度に1つのノードのみ編集可能）
  - **修正箇所**: 
    - `/src/stores/mindmapStore.ts` の startEditing アクション
    - または `/src/components/Node/NodeComponent.tsx` の handleClick
  - **実装案1**: ストア修正
    ```typescript
    startEditing: (id: string) => {
      set((state) => {
        // 他の編集中ノードを自動保存
        state.nodes.forEach(node => {
          if (node.isEditing && node.id !== id) {
            node.isEditing = false;
          }
        });
        // 新しいノードを編集開始
        const node = state.nodes.find(n => n.id === id);
        if (node) node.isEditing = true;
      });
    }
    ```
  - **実装案2**: コンポーネント修正
    ```typescript
    // handleClick内で他の編集中ノードを確認・保存
    const editingNodes = nodes.filter(n => n.isEditing && n.id !== node.id);
    editingNodes.forEach(n => stopEditing(n.id));
    ```
  - **テスト方法**: ノードA編集中にノードBをクリック、Aが自動保存されBのみ編集状態を確認
  - **優先度**: 高（データ整合性の問題）

##### 8B: 接続操作の改善（中優先度）
- [ ] **矢印操作のキャンセル機能**
  - **現在の問題**: 接続作成・変更の途中でキャンセルできない
    - 新規作成時: 接続点ドラッグ開始後、空クリックしても作成が継続される
    - 変更時: エンドポイント編集中に空クリックしても変更が継続される
    - 影響: 誤操作時の回復方法がない、操作を完了せざるを得ない状況
  - **期待動作**: 
    - 新規作成時: 空クリックで点線プレビューが消え、作成キャンセル
    - 変更時: 空クリックで元の接続状態に戻る（変更をロールバック）
  - **修正方針**:
    - Canvas.tsx の handleStageClick で接続状態をチェック
    - isConnecting=true 時の空クリックで endConnection() 呼び出し
    - isEditingConnection=true 時の空クリックで cancelConnectionEndpointEdit() 呼び出し
  - **修正箇所**: `/src/components/Canvas/Canvas.tsx`
    - handleStageClick 関数内（行29-324）で接続状態の分岐処理追加
    - 現在は一部実装済みだが、編集モードのキャンセル処理が不完全
  - **実装案**:
    ```typescript
    // handleStageClick内で追加
    if (canvasState.isConnecting) {
      endConnection(); // 既存実装
      return;
    }
    if (canvasState.isEditingConnection) {
      cancelConnectionEndpointEdit(); // キャンセル処理を追加
      return;
    }
    ```
  - **テスト方法**: 
    - 接続点ドラッグ後、空の場所をクリックして点線が消えることを確認
    - エンドポイント編集中に空クリックして元の接続に戻ることを確認
  - **優先度**: 中（操作性向上）

- [ ] **矢印ダブルクリック動作安定化**
  - **現在の問題**: ラベル選択後に編集モードに入ってしまう場合がある
    - 症状: ラベル選択画面で関係性を選んだ後、なぜかエンドポイント編集モードが起動
    - 原因: ConnectionLabelEditor の onSave 後の状態クリア不完全
    - 副原因: Canvas.tsx のダブルクリック検出との競合
    - 影響: ユーザーの期待と異なる動作、操作フローの混乱
  - **期待動作**: ラベル選択後は通常の接続線表示に戻る（編集モードなし）
  - **修正方針**:
    - ConnectionLabelEditor の onSave 時に編集状態を完全クリア
    - stopEditingConnectionLabel アクションの改善
    - Canvas での接続編集状態の適切な管理
  - **修正箇所**: 
    - `/src/stores/mindmapStore.ts` の stopEditingConnectionLabel アクション
    - `/src/components/Canvas/Canvas.tsx` のダブルクリック検出ロジック
    - `/src/components/Connection/ConnectionLabelEditor.tsx` の onSave 処理
  - **現在の stopEditingConnectionLabel の問題点**: 
    ```typescript
    // 行331-348で実装済みだが、さらに確実にする必要がある
    stopEditingConnectionLabel: (id: string) => {
      // 以下を確実に実行
      // connection.isEditingLabel = false;
      // connection.isSelected = false;
      // state.canvas.isEditingConnection = false;
      // state.canvas.editingConnectionId = undefined;
      // state.selectedConnectionId = undefined;
    }
    ```
  - **実装案**: ConnectionLabelEditor内でのより確実な状態クリア
    ```typescript
    const handleLabelSave = (label: string) => {
      updateConnection(connection.id, { label });
      stopEditingConnectionLabel(connection.id);
      // 追加: 明示的に選択解除
      selectConnection(undefined);
    };
    ```
  - **テスト方法**: 
    - 接続線ダブルクリック → ラベル選択 → 通常表示に戻ることを複数回確認
    - ラベル選択後にエンドポイント編集モードに入らないことを確認
  - **優先度**: 中（予測可能な動作への改善）

##### 8C: LLM最適化アルゴリズム修正（高優先度）
- [ ] **LLM最適化チェーン検出アルゴリズム修正**
  - **現在の問題**: 最長パス検出が不正確、真のメインチェーンとブランチを識別できない
    - 症状: 1→2→3→4→5→6のメインチェーンがLLM最適化で主軸として認識されない
    - 原因: findLongestPath が単純な最長経路を探しており、意味的なメインフローを考慮していない
    - 具体例: 1→1-1→1-1-1（3ノード）の方が1→6（6ノード）より「長い」と判定される可能性
    - 影響: LLM分析時にサブチェーンがメインとして扱われ、構造理解が困難
  - **期待動作**: メインチェーン(1→2→3→4→5→6)を主軸として、各ブランチを適切に配置
    - Main Chain: 1→2→3→4→5→6
    - Branch from 1: 1→1-1→1-1-1  
    - Branch from 2: 2→2-1→2-2
    - Branch from 3: 3→3-1
  - **問題のあるアルゴリズム分析**: `/src/utils/mermaidGenerator.ts`
    ```typescript
    // 現在の findLongestPath (行347-361) の問題
    private findLongestPath(): Node[] {
      // 問題1: 各ノードから最長パスを探すため、ブランチが優先される可能性
      // 問題2: ノード名や数値による順序を考慮していない
      // 問題3: 実際の「フロー」ではなく単純な長さを優先
    }
    ```
  - **修正方針**:
    1. **セマンティック分析**: ノード名から数値を抽出し、1→2→3...の自然な順序を検出
    2. **ブランチ検出**: メインノードから分岐する接続を特定（1→1-1のパターン）
    3. **フロー優先度**: 連続する数値順序のチェーンを最優先で選択
    4. **階層構造**: メインチェーンの各ノードからのブランチを second-level として配置
  - **修正箇所**: `/src/utils/mermaidGenerator.ts`
    - findLongestPath メソッド（行347-361）を findMainChain に変更
    - findLongestPathFromNode メソッド（行367-397）を改良
    - generateStructuredCode メソッド（行265-341）のチェーン識別ロジック修正
  - **実装案**:
    ```typescript
    private findMainChain(): Node[] {
      // 1. ノード名から数値を抽出してソート
      const numberedNodes = this.nodes
        .map(node => ({ node, number: this.extractNumber(node.text) }))
        .filter(item => item.number !== null)
        .sort((a, b) => a.number! - b.number!);
      
      // 2. 連続する数値のチェーンを検出
      const mainChain = this.findConsecutiveChain(numberedNodes);
      
      // 3. チェーンが見つからない場合は従来の最長パス検出
      return mainChain.length > 0 ? mainChain : this.findLongestPathFallback();
    }
    
    private extractNumber(text: string): number | null {
      // "1", "2-1", "Node1" などから数値を抽出
      const match = text.match(/^(\d+)/);
      return match ? parseInt(match[1]) : null;
    }
    ```
  - **テスト方法**: 
    - 1→6のメインチェーンと1-1、2-1、3-1のブランチでテスト
    - LLM最適化タブでメインチェーンが `%% Main Chain` として最初に表示されることを確認
    - ブランチノードが `%% Branch` として後に配置されることを確認
  - **優先度**: 高（LLM分析品質に直結）

#### Phase 7B: ワークフロー改善（次期実装）
- [ ] **複数ノード作成ワークフロー改善**
  - 現在: ノード作成毎にツールバーボタンを押す必要がある
  - 改善: Spaceキー連打で連続ノード作成、Enterキーでノード作成+編集開始
  - 実装: キーボードショートカットの拡張
  - **優先度**: 中（作業効率改善）

- [ ] **接続作成効率化**
  - 現在: 接続点ドラッグのみで接続作成
  - 改善: ノード選択+Shiftクリックで即座に接続作成
  - 実装: 選択ノード状態での特殊クリック処理
  - **優先度**: 低（パワーユーザー向け）

- [ ] **マインドマップテンプレート**
  - 現在: 空白状態からのスタートのみ
  - 改善: 一般的なマインドマップ構造のテンプレート提供
  - 実装: プリセットノード・接続セットの定義
  - **優先度**: 低（初心者向け機能）

#### Phase 7C: パフォーマンス・安定性
- [ ] **大量ノード対応**
  - 現在: 20ノード超で若干の動作重さ
  - 改善: 仮想化による描画最適化
  - 実装: 画面外ノードの描画スキップ
  - **優先度**: 中（スケーラビリティ）

- [ ] **メモリリーク対策**
  - 現在: 長時間使用での若干のメモリ増加
  - 改善: イベントリスナー完全クリーンアップ
  - 実装: useEffectクリーンアップ関数の見直し
  - **優先度**: 低（長期使用時のみ影響）

- [ ] **エラーハンドリング強化**
  - 現在: 不正操作時のエラー表示が不十分
  - 改善: ユーザーフレンドリーなエラー表示
  - 実装: try-catch + toast通知システム
  - **優先度**: 中（ユーザー体験向上）

---

このロードマップは開発進行に合わせて更新します。
各タスク完了時にチェックボックスを更新してください。