# Mindmapify MVP実装ロードマップ

## 🎯 実装戦略

### 段階的アプローチ
- 各フェーズ完了時に動作確認
- 最小機能で先に進み、後で改善
- 型安全性を最優先

### 技術的重点
- 状態の不変性（Zustand + immer）
- レンダリング最適化（React.memo）
- イベントハンドリングの効率化

## 📋 実装フェーズ

### 🏗️ フェーズ1: 基盤構築（1-2日）
**目標**: データとキャンバスの基本構造

#### タスク1: 状態管理基盤構築
- [x] TypeScript型定義（Node, Connection, MindmapState）
- [x] Zustand store設計とセットアップ
- [x] 基本的なアクション（addNode, updateNode等）

**成功条件**: 型安全な状態管理ができる ✅

#### タスク2: Konvaキャンバス基本実装
- [x] Konva Stage/Layer構造
- [x] ズーム・パン機能
- [x] レスポンシブ対応

**成功条件**: 空のキャンバスが正常表示・操作できる ✅

### 🎯 フェーズ2: ノード操作（2-3日）
**目標**: ノードの作成・編集機能

#### タスク3: ノード作成機能
- [x] ツールバー「New Node」ボタンで新ノード生成
- [x] 視覚的フィードバック（選択状態、ホバー効果）
- [x] ドラッグ移動機能（座標変換問題修正済み）
- [x] キャンバスパン操作との競合状態解決

**成功条件**: ツールバーボタンでノードが出現し、正確にドラッグ移動できる ✅

#### タスク4: ノード編集機能
- [x] ダブルクリックでテキスト編集
- [x] インライン編集UI
- [x] リアルタイム更新

**成功条件**: ノードのテキストが編集できる ✅

### 🔗 フェーズ3: 接続とコード生成（2-3日）
**目標**: マインドマップの構造化

#### タスク5: ノード接続機能（修正版完成）
- [x] ノードに接続点を作成（常時表示）
- [x] 接続点をクリック&ドラッグ時に点線矢印を表示
- [x] 接続点固定位置（ドラッグで動かない）
- [x] 点線矢印を他ノードの接続点でドロップ時に実線接続に変換
- [x] 接続線の描画とアニメーション
- [x] 接続状態の管理
- [x] ノードID抽出ロジック修正（UUID完全対応）

**成功条件**: 接続点ドラッグで点線矢印表示、ドロップで実線接続作成 ✅

#### タスク6: Mermaidコード生成（ロジックツリー対応完成）
- [x] ノード構造→Mermaid構文変換（基本実装）
- [x] リアルタイム更新
- [x] サイドパネル表示
- [x] コピーボタン機能
- [x] 接続構造を含む完全なマインドマップコード生成
- [x] ルートノードの自動識別（最多接続ノード）
- [x] 階層構造の自動生成（再帰的構築）
- [x] リアルタイム更新の最適化（useMemoでメモ化）
- [x] 未接続ノードの処理
- [x] テキストクリーニング処理
- [x] Flowchart記法対応（ループ表現可能）
- [x] 関係性ラベル機能（12種類のプリセット）
- [x] 接続線ダブルクリックでラベル編集
- [x] ラベル付きFlowchartコード生成

**成功条件**: 論理関係を含むMermaid Flowchartコードが正確に生成される ✅

### ⚡ フェーズ4: 操作性向上（1-2日）
**目標**: 実用的で直感的な機能完成

#### 🎯 Phase 4A: 緊急UX改善（優先度：高）
**基本操作の改善** - ユーザビリティの根本的問題を解決

##### タスク7A: 視覚的改善
- [x] 矢印ヘッド表示の修正（方向性の明確化）
- [x] 接続線の視覚的改善（太さ、色、スタイル）

**成功条件**: 矢印の方向が一目で分かる ✅

##### タスク7B: ノード編集の改善
- [x] ノード内直接編集（別テキストボックス廃止）
- [x] テキスト自動折り返し（ノード縦長対応）
- [x] ノードサイズの動的調整

**成功条件**: ノード内で快適にテキスト編集ができる ✅

#### 🎯 Phase 4B: 操作性向上（優先度：中）
**編集機能の拡充** - より効率的な操作を実現

##### タスク8A: 削除・選択機能
- [x] Undo/Redo履歴管理（基本実装済み）
- [x] Clearボタン（全削除機能）
- [x] 個別ノード削除（Delete キー） - Deleteキー、ツールバーDeleteボタン対応完了
- [x] ツールバー削除ボタン改善（Delete/All Delete分離）
- [x] ノード選択状態の改善（1クリック編集仕様維持）
- [x] 接続線選択・削除の改善（視覚的フィードバック改善、ツールバーボタン対応）
- [x] 接続線ラベル編集機能の復旧（react-konva-utilsを使わずKonvaネイティブで実装）

**成功条件**: 直感的な削除・選択操作ができる

##### タスク8B: 接続線ラベル改善（優先度：高）
✅ **ラベル編集機能の使いやすさ向上** - より実用的なラベル機能

- [x] ラベル選択肢の調整（現在12種類 → 8種類に絞る）
  - 「原因」「結果」「手段」「具体例」「要素」「同類」「対比」「補完」の8つに統一完了
- [x] ラベル選択画面のレイアウト修正
  - 選択肢がはみ出している問題の解決（4列2行レイアウトに変更）
  - 削除・キャンセルボタンの位置調整（左右適切配置に修正）
  - エディターサイズの最適化（380px幅に拡大）
- [x] ラベル表示の改善
  - 現在の丸囲み表示を廃止（文字がはみ出している問題解決）
  - 完全にシンプルなテキストのみ表示に変更（背景・縁取り一切なし）
  - 接続線と同色で統一感のあるデザイン実現
  - 矢印近くでの視認性向上完了
- [ ] 接続線ダブルクリック検出の精度向上
  - 現在の座標変換問題を解決
  - より確実なヒット検出の実装
- [ ] キーボードショートカット追加
  - 数字キー1-8でプリセットラベル選択
  - Enterキーで保存、Escapeキーでキャンセル確認

**成功条件**: ラベル編集が直感的で実用的に使える

#### 🎯 Phase 4C: 将来的改善（優先度：低）
**高度な機能** - より豊富な機能を提供

##### タスク8C: 高度な編集機能
- [ ] コピー・ペースト機能
- [ ] 複数選択機能
- [ ] グループ化機能

##### タスク8D: システム改善
- [ ] パフォーマンス最適化（50ノード超での仮想化）
- [ ] エラーハンドリング強化
- [ ] アクセシビリティ改善
- [ ] TypeScript型定義の完全化
- [ ] メモリリーク対策の強化

**成功条件**: スムーズで直感的な操作感

### 🎯 Phase 5: 実用性向上（残課題）
**目標**: 本格的な実用ツールとしての完成度向上

#### タスク9AA: 接続線編集系バグ修正（優先度：緊急）
- [x] **ノードダブルクリック時の誤動作修正**: 関連矢印ラベル編集画面誤表示 ✅完了
  - 現在: ノードをダブルクリックすると、紐づいている矢印のラベル編集画面まで出現してしまう
  - 問題: ノード内編集時に矢印ラベル編集画面が邪魔になる
  - 改善: ノードダブルクリック時は矢印ラベル編集を起動しないよう修正
    - Canvas.tsxでノードクリック時の接続線ヒットテストをスキップ
    - NodeComponent.tsxでイベントバブリングを適切に停止
  - 影響: ユーザビリティの根本的問題、編集作業の妨げになる ✅解決済み
- [x] **矢印接続先変更機能の実装**: 既存矢印の再接続機能 ✅完了
  - 現在: 矢印を一度設定すると、宛先ノードや元ノードの変更ができない
  - 問題: 接続を間違えた場合に削除→再作成しか手段がない
  - 改善: 既存矢印の始点・終点を別のノードに変更できる機能実装
    - 選択された接続線に編集可能なハンドル（緑：始点、赤：終点）を表示
    - ハンドルクリックで編集モードに入り、新しいノードの接続点をクリックで再接続
    - Escapeキーでキャンセル、履歴管理対応
  - 方案: 矢印選択時に接続点をドラッグ可能にする、または右クリックメニューで変更
  - 影響: 編集の柔軟性と効率性の大幅向上 ✅達成

#### タスク9A: コア機能の実装（優先度：最高）
- [x] **COPYボタンの実装**: マーメイド記法のコピー機能
  - サイドパネルのCopyボタンが実際にクリップボードにコピーする
  - コピー成功時の視覚的フィードバック
  - このサイトの存在価値に直結する最重要機能 ✅完了

#### タスク9B: 操作性の根本改善（優先度：高）
- [x] **スクロール操作の修正**: マウスホイールをズーム→スクロールに変更
  - 現在: マウスホイール = ズームイン/アウト
  - 改善: マウスホイール = 縦横スクロール
  - ツールバーにZoom In/Out ボタンを追加（ピンチ操作では見たい場所を正確にズームできない）
- [x] **極端なズーム時の問題解決**: ノード表示消失問題
  - 極端なズームイン/アウト時にノードが見えなくなる現象の修正
  - ズーム範囲の制限またはノード追跡機能の実装
- [x] **ズーム操作の改善**: ボタンベースのズーム制御
  - ツールバーに「Zoom In」「Zoom Out」「Reset Zoom」ボタン追加
  - マウスカーソル位置中心でのズーム実装
  - 現在のピンチ操作では意図した位置をズームできずノードを見失う問題の解決

#### タスク9C: UI/UX改善（優先度：高）
- [ ] **ボタン状態管理の改善**: Delete Node/Line ボタンの適切な有効化
  - Delete Node: ノード編集/選択モード時のみアクティブ
  - Delete Line: 接続線選択時のみアクティブ
  - 現在は常時アクティブで混乱を招いている
- [x] **ノード削除動作の改善**: 誤削除防止の実装
  - 現在: ノード内文字を全削除後にBackspace/Deleteでノード自体が削除される
  - 問題: 動作ミスが起こりやすい危険な仕様
  - 改善: ノード削除はDelete Nodeボタンのみに集約し、テキスト削除とノード削除を分離 ✅完了
- [x] **ノード内テキスト編集の改善**: ペースト機能の実装
  - 現在: ノード内にテキストをペーストできない
  - 改善: Ctrl+V でのペースト機能を有効化
  - クリップボードからのテキスト貼り付け対応 ✅完了
- [x] **ノード編集の操作性改善**: 直感的な保存・キャンセル操作 ✅完了
  - 現在: ノード外クリックで編集がキャンセルされ、Ctrl+Enterでしか確定できない
  - 問題: 直感的でない操作方法、操作方法が分からない
  - 改善1: ノード外クリックでも編集内容を自動保存 ✅完了
  - 改善2: 編集中に操作ヒント表示を復活（「Ctrl+Enter: 保存、Esc: キャンセル」等） ✅完了
- [ ] **New Node位置改善**: ノード重複回避
  - 現在: 常にデフォルト位置に生成されノードが重なる
  - 改善: 既存ノードと重ならない位置に自動生成
  - ノード数と位置の視認性向上
- [ ] **ボタン名称統一**: 動詞+名詞形式への統一
  - New Node → Add Node
  - Clear → Delete All
  - 操作の一貫性向上

#### タスク9D: 履歴・ショートカット機能（優先度：中）
- [ ] **Undo機能の実装**: 一つ戻るボタン
  - 現在やり直しが効かない状況の改善
  - ツールバーにUndoボタン追加
  - Ctrl+Z ショートカット対応
- [ ] **包括的ショートカットキー**: 高速操作の実現
  - Command+A+N: Add Node
  - Command+D+N: Delete Node
  - Command+Z: Undo
  - Command+Y: Redo
  <!-- - 数字1-8: ラベルプリセット選択 -->

#### タスク9E: 接続点表示改善（優先度：中）
- [ ] **接続点の条件表示**: 視認性向上実験
  - 現在: 常時表示でノードの視認性が低下
  - 実験: ノード編集状態時のみ接続点表示
  - 編集しやすさと視認性のバランス検証
  - ユーザビリティテストで効果測定

**成功条件**: 実用的で効率的なマインドマップ作成ツール完成

## 🚀 マイルストーン進捗

### ✅ フェーズ1完了: 基盤構築
**目標**: 「ツールバーボタンでノード作成・移動」達成済み
- ✅ 空のキャンバス表示
- ✅ ツールバーでノード作成
- ✅ ドラッグ移動（座標問題修正済み）
- ✅ 基本的なMermaidコード生成

### ✅ フェーズ2完了: ノード操作
**目標**: 「ダブルクリックでテキスト編集」達成済み
- ✅ ノード作成・編集・移動の基本操作
- ✅ インライン編集UI
- ✅ テキスト入力とリアルタイム更新

### ✅ フェーズ3完了: 接続とコード生成
**目標**: 「論理関係を含むMermaid Flowchartコードが正確に生成される」達成済み
- ✅ 常時表示接続点システム
- ✅ 点線プレビュー → 実線接続変換
- ✅ 関係性ラベル機能（12種類プリセット）
- ✅ Flowchart記法対応（ループ表現可能）
- ✅ ロジックツリー構造の自動生成

### ✅ Phase 4A完了: 緊急UX改善
**目標**: 「基本操作の根本的問題解決」達成済み
- ✅ 矢印方向の明確化（三角形矢印ヘッド実装）
- ✅ ノード内直接編集（テキストエリア改善）
- ✅ テキスト自動折り返し（動的ノードサイズ対応）

### 🔄 現在のマイルストーン: Phase 4B 操作性向上（進行中）
**目標**: 「編集機能の拡充」
- ✅ 個別ノード削除機能（Deleteキー・ツールバーボタン）
- ✅ ツールバー削除ボタン改善（Delete/All Delete分離）
- ✅ ノード選択状態の改善（1クリック編集仕様維持）
- ⏳ 接続線選択・削除の改善
- ⏳ 接続線ラベル編集機能の復旧

**残りタスク**: 接続線関連の操作性改善

## 🎯 現在の機能概要

### ✅ 実装済み機能
- **ノード操作**: ツールバーでの作成、ドラッグ移動、1クリック編集、自動リサイズ
- **テキスト編集**: Konva直接編集、カーソル制御、自動折り返し、複数行対応
- **削除機能**: 個別削除（Deleteキー・ツールバー）、全削除、関連接続線自動削除
- **接続システム**: 常時表示接続点、点線プレビュー、実線接続
- **関係性ラベル**: 12種類プリセット（具体例、根拠、結果、同類、詳細、原因、手段、対比、解決策、前提、要素、補完）
- **コード生成**: Mermaid Flowchart記法、ループ対応、ラベル付き矢印
- **UI/UX**: レスポンシブキャンバス、リアルタイム更新、履歴管理（Undo/Redo）

### ✅ Phase 4A で解決済みの問題
- **矢印方向不明**: 三角形矢印ヘッドで方向性を明確化済み
- **編集の煩雑さ**: ノード内直接編集（テキストエリア）に改善済み
- **テキスト見切れ**: 自動折り返しと動的ノードサイズに改善済み

### 🎮 操作方法
1. **ノード作成**: ツールバー「New Node」ボタン
2. **ノード編集**: ダブルクリックでインライン編集（Ctrl+Enter保存、Esc取消）
3. **接続作成**: 接続点をドラッグ&ドロップ
4. **ラベル編集**: 接続線をダブルクリック
5. **コード取得**: サイドパネル「Copy」ボタン

## 📝 開発メモ

### 決定事項
- TypeScript strict mode使用
- Zustand + immer for 状態管理
- Konva for キャンバス描画
- react-konva-utils for HTML overlay
- Mermaid Flowchart記法採用（ループ対応）
- 関係性ラベル12種類プリセット
- 常時表示接続点システム
- Puppeteer for E2Eテスト自動化

### 注意点
- パフォーマンス: 50ノード超で仮想化検討
- Mermaidコード生成: useMemoでメモ化済み
- メモリリーク: useEffectクリーンアップ必須
- 座標変換: StageドラッグとNodeドラッグの競合解決済み
- UUID処理: 接続点IDの適切な分割が重要

### 🧪 テスト環境
- `npm run test:quick` - 5秒自動テスト（headless）
- `npm run test:debug` - ブラウザ表示テスト + スクリーンショット
- `npm run test:drag` - ドラッグ動作専用デバッグテスト

---

このロードマップは開発進行に合わせて更新します。
各タスク完了時にチェックボックスを更新してください。